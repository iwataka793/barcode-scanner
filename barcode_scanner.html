<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* CSSスタイリング */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        h1 {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        #interactive-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 50vh;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        #interactive-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            display: none;
            transition: background-color 0.3s ease;
            text-align: center;
            width: 90%;
            max-width: 600px;
        }
        #controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 90%;
            max-width: 600px;
        }
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-size: 1em;
            transition: background-color 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        #scanButton { background-color: #4CAF50; }
        #resetButton { background-color: #f44336; }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* スキャン履歴 */
        #history {
            margin-top: 20px;
            width: 90%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: 200px;
        }
        #history h2 {
            margin-top: 0;
            text-align: center;
            font-size: 1.2em;
            color: #333;
        }
        #history ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #history li {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
            font-size: 1em;
            color: #555;
        }
        /* レスポンシブデザイン */
        @media (max-width: 600px) {
            #interactive-container {
                height: 40vh;
            }
            .button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <h1>バーコードスキャナー</h1>
    <div id="interactive-container"></div>
    <div id="result"></div>
    <div id="controls">
        <button id="scanButton" class="button">スキャン開始</button>
        <button id="resetButton" class="button">リセット</button>
    </div>
    <div id="history">
        <h2>スキャン履歴</h2>
        <ul id="historyList">
            <!-- スキャン履歴がここに追加されます -->
        </ul>
    </div>

    <!-- サウンドフィードバック用オーディオ要素 -->
    <audio id="beepSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

    <!-- QuaggaJSの読み込み -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        // 要素の取得
        const resultDiv = document.getElementById('result');
        const scanButton = document.getElementById('scanButton');
        const resetButton = document.getElementById('resetButton');
        const historyList = document.getElementById('historyList');
        const beepSound = document.getElementById('beepSound');
        const interactiveContainer = document.getElementById('interactive-container');

        let scannedCodes = new Set();
        let isScanning = false;
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];

        // プロダクトパターンの定義
        const productPatterns = {
            "5863S": "X-92-122",
            "GFEYS": "PLR-2"
            // 他のパターンを追加可能
        };

        // スキャン履歴を表示する関数
        function displayHistory() {
            historyList.innerHTML = '';
            scanHistory.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${index + 1}. ${item}`;
                historyList.appendChild(listItem);
            });
        }

        // 履歴を初期表示
        displayHistory();

        // バーコードから重要なセグメントを抽出する関数
        function extractImportantSegment(barcode) {
            // 左から4番目から5文字を抽出（インデックスは0から開始）
            if (barcode.length >= 9) { // バーコードが最低9桁あるか確認
                return barcode.substring(3, 8); // インデックス3から7までの5文字を抽出
            }
            return null; // 短すぎる場合はnullを返す
        }

        // バーコードを分類する関数
        function classifyProduct(barcode) {
            const segment = extractImportantSegment(barcode);
            if (segment) {
                return productPatterns[segment] || null;
            }
            return null;
        }

        // 結果を表示する関数
        function showResult(message, color, code = '') {
            resultDiv.style.display = 'block';
            resultDiv.style.backgroundColor = color;
            if (code) {
                resultDiv.innerHTML = `<strong>${message}</strong><br>${code}`;
            } else {
                resultDiv.textContent = message;
            }

            // サウンドフィードバックと振動フィードバック
            if (color === 'green') {
                beepSound.play().catch((e) => {
                    console.error('サウンドの再生に失敗しました:', e);
                });
            } else if (color === 'red' && navigator.vibrate) {
                navigator.vibrate(500); // NGの場合に振動
            }
        }

        // 結果をクリアする関数
        function clearResult() {
            resultDiv.style.display = 'none';
            resultDiv.textContent = '';
        }

        // スキャンを開始する関数
        function startScanner() {
            if (isScanning) return;
            clearResult();
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactiveContainer,
                    constraints: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true,
                frequency: 10 // フレームレートを調整して読み取り速度を最適化
            }, function(err) {
                if (err) {
                    console.error(err);
                    showResult("カメラの初期化に失敗しました。", 'red');
                    return;
                }
                Quagga.start();
                isScanning = true;
                scanButton.textContent = "スキャン停止";
            });

            Quagga.onDetected(onDetected);
        }

        // バーコード検出時の処理
        function onDetected(data) {
            const code = data.codeResult.code;
            console.log("検出されたバーコード:", code);

            const product = classifyProduct(code);

            if (product) {
                if (scannedCodes.has(code)) {
                    showResult(`NG: 重複したコードです`, 'red', code);
                } else {
                    scannedCodes.add(code);
                    scanHistory.push(`${code} - ${product}`);
                    localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
                    displayHistory();
                    showResult(`OK: ${product}`, 'green', code);
                }
            } else {
                showResult(`NG: 未登録のコードです`, 'red', code);
            }

            Quagga.stop();
            isScanning = false;
            scanButton.textContent = "スキャン開始";

            // 3秒後に自動で再スキャンを開始
            setTimeout(() => {
                startScanner();
            }, 3000);
        }

        // スキャンをリセットする関数
        function resetScanner() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
                scanButton.textContent = "スキャン開始";
            }
            clearResult();
            scannedCodes.clear();
            scanHistory = [];
            localStorage.removeItem('scanHistory');
            displayHistory();
        }

        // スキャン開始/停止ボタンのイベントリスナー
        scanButton.addEventListener('click', () => {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
                scanButton.textContent = "スキャン開始";
            } else {
                startScanner();
            }
        });

        // リセットボタンのイベントリスナー
        resetButton.addEventListener('click', () => {
            resetScanner();
        });

        // サウンドを事前にロードするためのユーザータップイベント
        document.body.addEventListener('click', () => {
            if (beepSound.paused && beepSound.readyState >= 2) {
                beepSound.play().then(() => {
                    beepSound.pause();
                    beepSound.currentTime = 0;
                }).catch((e) => {
                    console.warn('サウンドの事前ロードに失敗:', e);
                });
            }
        }, { once: true });
    </script>
</body>
</html>
