<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }

        body {
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        /* 全体ラッパー（中央寄せ・最大幅） */
        .wrapper {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 12px 24px;
        }

        h1 {
            text-align: center;
            margin: 10px 0 16px;
            font-size: clamp(1.8rem, 4vw, 2.6rem);
        }

        /* ボタン行 */
        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .button {
            padding: 12px 26px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            min-width: 120px;
        }
        .button:hover {
            background-color: #0056b3;
        }

        #resetButton {
            background-color: #dc3545;
        }
        #resetButton:hover {
            background-color: #c82333;
        }

        /* 名前選択行 */
        .operator-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .operator-row label {
            font-size: 1rem;
        }

        #operatorSelect {
            padding: 6px 10px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .operator-display {
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        /* スキャンエリア */
        #interactive-wrapper {
            width: 100%;
            margin: 6px auto 10px;
        }

        #interactive.viewport {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            /* 縦横どちらでもつぶれないように高さを確保 */
            height: 48vh;
            min-height: 220px;
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* スキャンガイド */
        #interactive.viewport::before {
            content: "";
            position: absolute;
            top: 25%;
            left: 10%;
            width: 80%;
            height: 50%;
            border: 2px solid rgba(0, 255, 0, 0.7);
            box-sizing: border-box;
            pointer-events: none;
        }

        /* 結果表示 */
        #result {
            margin-top: 12px;
            padding: 14px;
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            display: none;
            text-align: center;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        /* 履歴テーブル周り */
        #historyContainer {
            margin-top: 14px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            padding: 10px;
        }

        #historyTitle {
            font-weight: bold;
            margin: 0 0 8px;
            font-size: 1.05rem;
        }

        #historyTableWrapper {
            max-height: 30vh;   /* 横画面で潰さないように高さを制限してスクロール */
            overflow-y: auto;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 480px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background-color: #f7f7f7;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* 画面向きごとの調整 */
        @media (orientation: landscape) {
            #interactive.viewport {
                height: 45vh;
                min-height: 200px;
            }

            #historyTableWrapper {
                max-height: 32vh;
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            #interactive.viewport {
                height: 55vh;
            }
        }
    </style>

    <!-- QuaggaJSのCDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
<div class="wrapper">
    <h1>バーコードスキャナー</h1>

    <div id="controls">
        <button id="scanButton" class="button">スキャン開始</button>
        <button id="resetButton" class="button">リセット</button>
        <button id="printButton" class="button">印刷</button>
    </div>

    <div class="operator-row">
        <label for="operatorSelect">名前：</label>
        <select id="operatorSelect">
            <option value="">選択してください</option>
            <!-- ★ここに使う人の名前を増やしてOK -->
            <option value="岩田薫">岩田薫</option>
            <option value="佐藤">佐藤</option>
            <option value="鈴木">鈴木</option>
            <option value="田中">田中</option>
        </select>
    </div>
    <div class="operator-display" id="operatorDisplay">担当者：未選択</div>

    <div id="interactive-wrapper">
        <div id="interactive" class="viewport"></div>
    </div>

    <div id="result"></div>

    <!-- 履歴表示（最大100件） -->
    <div id="historyContainer">
        <p id="historyTitle">スキャン履歴（最大100件）</p>
        <div id="historyTableWrapper">
            <table>
                <thead>
                <tr>
                    <th>No.</th>
                    <th>時刻</th>
                    <th>判定</th>
                    <th>品番</th>
                    <th>バーコード</th>
                </tr>
                </thead>
                <tbody id="historyBody">
                <!-- JSで追加 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ===== エラーハンドリング =====
    window.onerror = function(message, source, lineno, colno, error) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.backgroundColor = 'red';
        resultDiv.textContent = `エラー: ${message} at ${source}:${lineno}:${colno}`;
        resultDiv.style.display = 'block';
        document.body.style.backgroundColor = 'red';
        console.error("Unhandled error:", message, source, lineno, colno, error);
    };

    // ===== 商品パターン定義 =====
    const productPatterns = {
        "5863S": "X-92-122",
        "GFEYS": "PLR-2"
        // 必要に応じて追加
    };

    let previousProduct = null;
    let isScanning = false;

    // 履歴（最大100件）
    const MAX_HISTORY = 100;
    const scanHistory = [];  // {timestamp, status, product, barcode}

    // 誤認識対策（高速版）：同じバーコードが2フレーム連続で出たら確定
    let lastDetectedCode = null;
    let confirmCount = 0;

    // ===== 表示系ユーティリティ =====
    function showResult(message, color) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.backgroundColor = color;
        resultDiv.innerHTML = message;
        resultDiv.style.display = 'block';
        document.body.style.backgroundColor = color;
    }

    function clearResult() {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'none';
        document.body.style.backgroundColor = '#f0f0f0';
    }

    // バーコードから重要部分を抜き出し
    function extractImportantSegment(barcode) {
        if (barcode.length >= 9) {
            return barcode.substring(4, 9);
        }
        return null;
    }

    // バーコードを品番に分類
    function classifyProduct(barcode) {
        const segment = extractImportantSegment(barcode);
        if (!segment) return null;
        return productPatterns[segment] || null;
    }

    // 履歴に追加 & テーブル更新
    function addScanHistory(entry) {
        scanHistory.push(entry);
        if (scanHistory.length > MAX_HISTORY) {
            scanHistory.shift();
        }

        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "";

        scanHistory.forEach((item, index) => {
            const tr = document.createElement('tr');

            const tdNo = document.createElement('td');
            tdNo.textContent = index + 1;

            const tdTime = document.createElement('td');
            tdTime.textContent = item.timestamp;

            const tdStatus = document.createElement('td');
            tdStatus.textContent = item.status;

            const tdProduct = document.createElement('td');
            tdProduct.textContent = item.product || "";

            const tdBarcode = document.createElement('td');
            tdBarcode.textContent = item.barcode;

            tr.appendChild(tdNo);
            tr.appendChild(tdTime);
            tr.appendChild(tdStatus);
            tr.appendChild(tdProduct);
            tr.appendChild(tdBarcode);

            tbody.appendChild(tr);
        });
    }

    // ===== スキャン結果処理 =====
    function handleDetected(barcode) {
        console.log("検出されたバーコード:", barcode);
        const product = classifyProduct(barcode);
        const nowStr = new Date().toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        let status = "";
        if (product) {
            if (product === previousProduct) {
                status = "NG(重複)";
                showResult(`NG: ${product} を重複して読み取りました<br>${barcode}`, 'red');
            } else {
                if (previousProduct !== null) {
                    status = "OK(変更)";
                    showResult(`OK: ${previousProduct} → ${product}<br>${barcode}`, '#28a745');
                } else {
                    status = "検出";
                    showResult(`検出: ${product}<br>${barcode}`, '#007BFF');
                }
            }
            previousProduct = product;
        } else {
            status = "未分類";
            showResult(`バーコードが認識できません<br>${barcode}`, 'gray');
        }

        addScanHistory({
            timestamp: nowStr,
            status: status,
            product: product,
            barcode: barcode
        });

        // 一回読んだらいったん停止（必要ならコメントアウト）
        stopScanner();
    }

    // Quagga の onDetected（高速＋誤認識対策）
    function onDetected(data) {
        const barcode = data.codeResult.code;

        if (barcode === lastDetectedCode) {
            confirmCount += 1;
        } else {
            lastDetectedCode = barcode;
            confirmCount = 1;
        }

        if (confirmCount >= 2) {
            lastDetectedCode = null;
            confirmCount = 0;
            handleDetected(barcode);
        }
    }

    // ===== Quagga 初期化 =====
    function startScanner() {
        if (isScanning) return;

        clearResult();

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                singleChannel: false
            },
            decoder: {
                readers: ["code_128_reader"],
                multiple: false
            },
            locate: true,
            numOfWorkers: navigator.hardwareConcurrency || 4
        }, function(err) {
            if (err) {
                console.error(err);
                alert("バーコードスキャナーの初期化に失敗しました。");
                return;
            }
            Quagga.start();
            isScanning = true;
            document.getElementById('scanButton').textContent = "スキャン停止";
            Quagga.onDetected(onDetected);
        });
    }

    function stopScanner() {
        if (!isScanning) return;

        Quagga.stop();
        isScanning = false;
        document.getElementById('scanButton').textContent = "スキャン開始";
        Quagga.offDetected(onDetected);
    }

    // ===== ボタン類のイベント =====
    document.getElementById('scanButton').addEventListener('click', function() {
        if (isScanning) {
            stopScanner();
        } else {
            startScanner();
        }
    });

    document.getElementById('resetButton').addEventListener('click', function() {
        clearResult();
        previousProduct = null;
        lastDetectedCode = null;
        confirmCount = 0;
        console.log("reset: previousProduct / lastDetectedCode / confirmCount をリセット");
        stopScanner();
        startScanner();
    });

    // 名前選択
    const operatorSelect = document.getElementById('operatorSelect');
    const operatorDisplay = document.getElementById('operatorDisplay');

    operatorSelect.addEventListener('change', function() {
        const name = operatorSelect.value || "未選択";
        operatorDisplay.textContent = "担当者：" + name;
    });

    // 印刷ボタン
    document.getElementById('printButton').addEventListener('click', function() {
        if (scanHistory.length === 0) {
            alert("印刷する履歴がありません。");
            return;
        }
        const operatorName = operatorSelect.value;
        if (!operatorName) {
            alert("印刷する前に名前を選択してください。");
            return;
        }

        let win = window.open("", "_blank");
        if (!win) {
            alert("ポップアップがブロックされています。許可してから再度お試しください。");
            return;
        }

        win.document.write(`
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <title>スキャン履歴印刷</title>
                <style>
                    body {
                        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                        padding: 16px;
                    }
                    h1 {
                        text-align: center;
                        margin-bottom: 4px;
                    }
                    .meta {
                        margin-bottom: 12px;
                        text-align: left;
                        font-size: 0.95rem;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 0.9rem;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 4px 6px;
                        text-align: left;
                        white-space: nowrap;
                    }
                    th {
                        background-color: #f0f0f0;
                    }
                </style>
            </head>
            <body>
                <h1>バーコードスキャン履歴</h1>
                <div class="meta">
                    <div>担当者：${operatorName}</div>
                    <div>印刷日時：${new Date().toLocaleString('ja-JP')}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>時刻</th>
                            <th>判定</th>
                            <th>品番</th>
                            <th>バーコード</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scanHistory.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.timestamp}</td>
                                <td>${item.status}</td>
                                <td>${item.product || ""}</td>
                                <td>${item.barcode}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
                <script>
                    window.onload = function() {
                        window.print();
                    };
                <\/script>
            </body>
            </html>
        `);
        win.document.close();
    });

    // 初期状態
    clearResult();
</script>
</body>
</html>
