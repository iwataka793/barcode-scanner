<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- スタイル -->
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }

        .page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 16px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            margin: 8px 0 16px;
            font-size: 2.2rem;
        }

        /* スキャナ領域 */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 55vh;          /* 基本の高さ */
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* スキャンガイド */
        #interactive.viewport::before {
            content: "";
            position: absolute;
            top: 20%;
            left: 8%;
            width: 84%;
            height: 60%;
            border: 3px solid rgba(0, 255, 0, 0.7);
            box-sizing: border-box;
            pointer-events: none;
        }

        /* 結果表示 */
        #result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 10px;
            color: #fff;
            font-size: 1.3rem;
            font-weight: bold;
            display: none;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        /* ボタン群 */
        #controls {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .button {
            padding: 14px 28px;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }

        .button:hover {
            background-color: #0056b3;
        }

        #resetButton {
            background-color: #dc3545;
        }
        #resetButton:hover {
            background-color: #c82333;
        }

        /* 名前選択 */
        .name-area {
            margin-top: 12px;
            padding: 10px 12px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 1rem;
        }

        .name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .name-row label {
            min-width: 3em;
        }

        #operatorSelect {
            flex: 1;
            padding: 6px 8px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #operatorDisplay {
            padding-left: 3.2em;
        }

        /* 履歴テーブル */
        #historySection {
            margin-top: 16px;
            padding: 12px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #historySection h2 {
            margin: 0 0 8px;
            font-size: 1.3rem;
        }

        .history-table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background: #f8f8f8;
        }

        .status-ok {
            color: #28a745;
            font-weight: bold;
        }
        .status-ng {
            color: #dc3545;
            font-weight: bold;
        }
        .status-info {
            color: #007BFF;
            font-weight: bold;
        }
        .status-unknown {
            color: #666;
            font-weight: bold;
        }

        /* スマホ縦向きで高さを少し高めに */
        @media (orientation: portrait) {
            #interactive.viewport {
                height: 60vh;
            }
        }

        /* 横向き：少し低くしても横長で見やすくする */
        @media (orientation: landscape) {
            #interactive.viewport {
                height: 50vh;
            }
        }
    </style>

    <!-- QuaggaJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
<div class="page">
    <h1>バーコードスキャナー</h1>

    <!-- スキャナ -->
    <div id="interactive" class="viewport"></div>

    <!-- ボタン -->
    <div id="controls">
        <button id="scanButton" class="button">スキャン開始</button>
        <button id="resetButton" class="button">リセット</button>
        <button id="printButton" class="button">印刷</button>
    </div>

    <!-- 名前選択 -->
    <div class="name-area">
        <div class="name-row">
            <label for="operatorSelect">名前：</label>
            <select id="operatorSelect">
                <option value="">選択してください</option>
            </select>
        </div>
        <div id="operatorDisplay">担当者：未選択</div>
    </div>

    <!-- 結果表示 -->
    <div id="result"></div>

    <!-- 履歴 -->
    <section id="historySection">
        <h2>スキャン履歴（最大100件）</h2>
        <div class="history-table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>No.</th>
                    <th>時刻</th>
                    <th>判定</th>
                    <th>品番</th>
                    <th>バーコード</th>
                </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </section>
</div>

<script>
    // ===== 設定値 =====
    const DETECTION_INTERVAL_MS = 200;   // B案：0.2秒ごとに1回だけ処理
    const MAX_HISTORY = 100;

    // 名前の候補（必要に応じて書き換えOK）
    const OPERATOR_CANDIDATES = [
        "岩田",
        "佐藤",
        "鈴木",
        "山田"
    ];

    // 商品データのパターン定義
    const productPatterns = {
        "5863S": "X-92-122",
        "GFEYS": "PLR-2"
        // 必要に応じて追加
    };

    let previousProduct = null;
    let isScanning = false;
    let lastDetectedTime = 0;
    let currentOperator = "";
    const history = [];

    // ===== ヘルパー関数 =====

    function showResult(message, color) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.backgroundColor = color;
        resultDiv.innerHTML = message;
        resultDiv.style.display = 'block';
        document.body.style.backgroundColor = color;
    }

    function clearResult() {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'none';
        document.body.style.backgroundColor = '#f0f0f0';
    }

    function extractImportantSegment(barcode) {
        if (barcode.length >= 9) {
            return barcode.substring(4, 9);
        }
        return null;
    }

    function classifyProduct(barcode) {
        const segment = extractImportantSegment(barcode);
        if (!segment) return null;
        return productPatterns[segment] || null;
    }

    function addHistoryEntry(status, product, barcode) {
        const now = new Date();
        const timestamp = now.toLocaleString('ja-JP', { hour12: false });

        history.unshift({
            time: timestamp,
            status,
            product: product || "",
            barcode: barcode || ""
        });

        if (history.length > MAX_HISTORY) {
            history.pop();
        }

        renderHistory();
    }

    function renderHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "";

        history.forEach((entry, index) => {
            const tr = document.createElement('tr');

            const tdNo = document.createElement('td');
            tdNo.textContent = index + 1;

            const tdTime = document.createElement('td');
            tdTime.textContent = entry.time;

            const tdStatus = document.createElement('td');
            tdStatus.textContent = entry.status;
            switch (entry.status) {
                case "OK":
                    tdStatus.classList.add('status-ok');
                    break;
                case "NG":
                    tdStatus.classList.add('status-ng');
                    break;
                case "検出":
                    tdStatus.classList.add('status-info');
                    break;
                default:
                    tdStatus.classList.add('status-unknown');
                    break;
            }

            const tdProduct = document.createElement('td');
            tdProduct.textContent = entry.product || "-";

            const tdBarcode = document.createElement('td');
            tdBarcode.textContent = entry.barcode || "-";

            tr.appendChild(tdNo);
            tr.appendChild(tdTime);
            tr.appendChild(tdStatus);
            tr.appendChild(tdProduct);
            tr.appendChild(tdBarcode);
            tbody.appendChild(tr);
        });
    }

    // ===== スキャン結果処理 =====

    function handleDetected(data) {
        const barcode = data.codeResult.code;
        console.log("検出されたバーコード:", barcode);
        const product = classifyProduct(barcode);

        if (product) {
            if (product === previousProduct) {
                // 同じ商品を連続で読んだ → NG
                showResult(`NG: ${product} を重複して読み取りました<br>${barcode}`, 'red');
                addHistoryEntry("NG", product, barcode);
            } else {
                if (previousProduct !== null) {
                    // 異なる商品へ切り替わった → OK
                    showResult(`OK: ${previousProduct} → ${product}<br>${barcode}`, '#28a745');
                    addHistoryEntry("OK", product, barcode);
                } else {
                    // 最初のスキャン
                    showResult(`検出: ${product}<br>${barcode}`, '#007BFF');
                    addHistoryEntry("検出", product, barcode);
                }
            }
            previousProduct = product;
            stopScanner(); // スキャン1回ごとに停止
        } else {
            // 分類できないバーコード
            showResult(`バーコードが認識できません<br>${barcode}`, 'gray');
            addHistoryEntry("不明", null, barcode);
        }
    }

    function onDetected(data) {
        const now = Date.now();
        if (now - lastDetectedTime < DETECTION_INTERVAL_MS) {
            return;
        }
        lastDetectedTime = now;
        handleDetected(data);
    }

    // ===== Quagga制御 =====

    function startScanner() {
        if (isScanning) return;

        clearResult();

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                singleChannel: false
            },
            decoder: {
                readers: ["code_128_reader"],
                multiple: false
            },
            locate: true,
            numOfWorkers: navigator.hardwareConcurrency || 4
        }, function (err) {
            if (err) {
                console.error(err);
                alert("バーコードスキャナーの初期化に失敗しました。");
                return;
            }
            Quagga.start();
            isScanning = true;
            document.getElementById('scanButton').textContent = "スキャン停止";
        });

        Quagga.onDetected(onDetected);
    }

    function stopScanner() {
        if (!isScanning) return;
        Quagga.stop();
        isScanning = false;
        document.getElementById('scanButton').textContent = "スキャン開始";
        Quagga.offDetected(onDetected);
    }

    // ===== 印刷 =====

    function handlePrint() {
        if (!currentOperator) {
            alert("印刷する前に「名前」を選択してください。");
            return;
        }
        if (history.length === 0) {
            alert("スキャン履歴がありません。");
            return;
        }

        const printWindow = window.open("", "_blank");
        if (!printWindow || !printWindow.document) {
            alert("ポップアップがブロックされました。ブラウザの設定を確認してください。");
            return;
        }

        const doc = printWindow.document;

        const escapedOperator = currentOperator.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        let tableRows = "";
        history.forEach((entry, index) => {
            tableRows += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${entry.time}</td>
                    <td>${entry.status}</td>
                    <td>${entry.product || ""}</td>
                    <td>${entry.barcode || ""}</td>
                </tr>`;
        });

        doc.open();
        doc.write(`
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <title>スキャン履歴</title>
                <style>
                    body {
                        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                        margin: 16px;
                    }
                    h1 {
                        font-size: 1.6rem;
                        margin-bottom: 4px;
                    }
                    .meta {
                        margin-bottom: 12px;
                        font-size: 0.95rem;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 0.9rem;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 4px 6px;
                        text-align: left;
                        white-space: nowrap;
                    }
                    th {
                        background: #eee;
                    }
                </style>
            </head>
            <body>
                <h1>バーコードスキャン履歴</h1>
                <div class="meta">
                    担当者：${escapedOperator}<br>
                    印刷日時：${new Date().toLocaleString('ja-JP', { hour12: false })}
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>時刻</th>
                            <th>判定</th>
                            <th>品番</th>
                            <th>バーコード</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </body>
            </html>
        `);
        doc.close();

        // iOS 対策で少し待ってから印刷
        setTimeout(() => {
            try {
                printWindow.focus();
                printWindow.print();
            } catch (e) {
                console.error(e);
            }
        }, 300);
    }

    // ===== 名前の初期化 =====

    function initOperatorSelector() {
        const select = document.getElementById('operatorSelect');
        const display = document.getElementById('operatorDisplay');

        // 選択肢を追加
        OPERATOR_CANDIDATES.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

        // 前回の選択を復元
        const saved = localStorage.getItem('barcode_scanner_operator');
        if (saved && OPERATOR_CANDIDATES.includes(saved)) {
            select.value = saved;
            currentOperator = saved;
            display.textContent = `担当者：${saved}`;
        }

        select.addEventListener('change', () => {
            currentOperator = select.value;
            if (currentOperator) {
                display.textContent = `担当者：${currentOperator}`;
                localStorage.setItem('barcode_scanner_operator', currentOperator);
            } else {
                display.textContent = "担当者：未選択";
                localStorage.removeItem('barcode_scanner_operator');
            }
        });
    }

    // ===== イベント設定 =====

    document.addEventListener('DOMContentLoaded', () => {
        initOperatorSelector();

        document.getElementById('scanButton').addEventListener('click', () => {
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        });

        document.getElementById('resetButton').addEventListener('click', () => {
            clearResult();
            previousProduct = null;
            stopScanner();
            startScanner();   // リセット後は自動で再開
        });

        document.getElementById('printButton').addEventListener('click', handlePrint);

        clearResult();
    });
</script>
</body>
</html>

