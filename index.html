<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
        }

        body {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
        }

        /* 中央寄せラッパー */
        .wrapper {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 12px 24px;
        }

        h1 {
            text-align: center;
            margin: 10px 0 12px;
            font-size: clamp(1.8rem, 4vw, 2.6rem);
        }

        /* ===== スキャン画面 ===== */
        #interactive-wrapper {
            width: 100%;
            margin: 0 auto;
        }

        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 60vh;            /* 基本の高さ */
            max-height: 480px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ガイド枠 */
        #interactive.viewport::before {
            content: "";
            position: absolute;
            top: 20%;
            left: 8%;
            width: 84%;
            height: 60%;
            border: 2px solid rgba(0, 255, 0, 0.7);
            pointer-events: none;
        }

        /* 結果表示 */
        #result {
            margin-top: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            display: none;
            text-align: center;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        /* ボタン行（カメラの下） */
        #controls {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .button {
            min-width: 140px;
            padding: 14px 26px;
            font-size: 1.05rem;
            border: none;
            border-radius: 10px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button-red {
            background-color: #dc3545;
        }

        .button-red:hover {
            background-color: #c82333;
        }

        /* 名前選択 */
        .name-row {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            justify-content: center;
        }

        .name-row label {
            font-weight: bold;
        }

        #nameSelect {
            min-width: 200px;
            padding: 6px 10px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #fff;
        }

        #currentOperator {
            margin-top: 4px;
            text-align: center;
            font-size: 0.95rem;
        }

        /* 履歴テーブル */
        #history-section {
            margin-top: 18px;
            background: #fff;
            border-radius: 12px;
            padding: 12px 10px 14px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        #history-section h2 {
            margin: 4px 0 10px;
            font-size: 1.2rem;
            text-align: left;
        }

        .history-table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: #f5f5f5;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: center;
            white-space: nowrap;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        /* 横向き時：カメラを少し低くして全体を収める */
        @media (orientation: landscape) {
            #interactive.viewport {
                height: 50vh;
                max-height: 380px;
            }
        }

        /* スマホ縦向き（狭い画面） */
        @media (max-width: 768px) and (orientation: portrait) {
            #interactive.viewport {
                height: 55vh;
            }
            .button {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 0.95rem;
            }
        }
    </style>

    <!-- QuaggaJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
<div class="wrapper">
    <h1>バーコードスキャナー</h1>

    <!-- カメラ -->
    <div id="interactive-wrapper">
        <div id="interactive" class="viewport"></div>
    </div>

    <!-- 判定結果 -->
    <div id="result"></div>

    <!-- ボタン -->
    <div id="controls">
        <button id="scanButton" class="button">スキャン開始</button>
        <button id="resetButton" class="button button-red">リセット</button>
        <button id="printButton" class="button">印刷</button>
    </div>

    <!-- 名前選択 -->
    <div class="name-row">
        <label for="nameSelect">名前：</label>
        <select id="nameSelect">
            <option value="">選択してください</option>
            <option value="岩田">岩田</option>
            <option value="佐藤">佐藤</option>
            <option value="鈴木">鈴木</option>
            <option value="田中">田中</option>
            <option value="その他">その他</option>
        </select>
    </div>
    <div id="currentOperator">担当者：<span id="currentName">未選択</span></div>

    <!-- 履歴 -->
    <section id="history-section">
        <h2>スキャン履歴（最大100件）</h2>
        <div class="history-table-wrapper">
            <table id="historyTable">
                <thead>
                <tr>
                    <th>No.</th>
                    <th>時刻</th>
                    <th>判定</th>
                    <th>品番</th>
                    <th>バーコード</th>
                </tr>
                </thead>
                <tbody>
                <!-- ここにJSで追加 -->
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
    // ===== エラーハンドリング =====
    window.onerror = function(message, source, lineno, colno, error) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.backgroundColor = 'red';
        resultDiv.textContent = `エラー: ${message} at ${source}:${lineno}:${colno}`;
        resultDiv.style.display = 'block';
        document.body.style.backgroundColor = 'red';
        console.error("Unhandled error:", message, source, lineno, colno, error);
    };

    // ===== 商品パターン定義 =====
    const productPatterns = {
        "5863S": "X-92-122",
        "GFEYS": "PLR-2"
        // 必要に応じて追加
    };

    let previousProduct = null;
    let isScanning = false;

    // 誤認識低減用
    let lastBarcode = null;
    let sameCount = 0;
    const REQUIRED_SAME_COUNT = 2; // 同じ値を2回連続検出で確定

    // 履歴（最大100件）
    const scanHistory = [];
    const MAX_HISTORY = 100;

    // ===== 表示系 =====
    function showResult(message, color) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.backgroundColor = color;
        resultDiv.innerHTML = message;
        resultDiv.style.display = 'block';
        document.body.style.backgroundColor = color;
    }

    function clearResult() {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'none';
        document.body.style.backgroundColor = '#f0f0f0';
    }

    // ===== バーコード処理 =====
    function extractImportantSegment(barcode) {
        if (barcode.length >= 9) {
            return barcode.substring(4, 9); // 5文字
        }
        return null;
    }

    function classifyProduct(barcode) {
        const segment = extractImportantSegment(barcode);
        if (!segment) return null;
        return productPatterns[segment] || null;
    }

    function addHistoryEntry(timestamp, judgment, product, barcode) {
        scanHistory.push({timestamp, judgment, product, barcode});
        if (scanHistory.length > MAX_HISTORY) {
            scanHistory.shift();
        }
        updateHistoryTable();
    }

    function updateHistoryTable() {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        scanHistory.forEach((item, index) => {
            const tr = document.createElement('tr');
            const noTd = document.createElement('td');
            const timeTd = document.createElement('td');
            const judgeTd = document.createElement('td');
            const productTd = document.createElement('td');
            const barcodeTd = document.createElement('td');

            noTd.textContent = index + 1;
            timeTd.textContent = item.timestamp;
            judgeTd.textContent = item.judgment;
            productTd.textContent = item.product || '';
            barcodeTd.textContent = item.barcode;

            tr.appendChild(noTd);
            tr.appendChild(timeTd);
            tr.appendChild(judgeTd);
            tr.appendChild(productTd);
            tr.appendChild(barcodeTd);
            tbody.appendChild(tr);
        });
    }

    function handleDetected(data) {
        if (!data || !data.codeResult || !data.codeResult.code) return;

        const rawCode = data.codeResult.code;

        // 同じコードを一定回数連続検出したときだけ確定
        if (rawCode === lastBarcode) {
            sameCount++;
        } else {
            lastBarcode = rawCode;
            sameCount = 1;
        }
        if (sameCount < REQUIRED_SAME_COUNT) {
            return;
        }
        sameCount = 0; // 確定したのでリセット

        const barcode = rawCode;
        console.log("検出されたバーコード:", barcode);
        const product = classifyProduct(barcode);

        const now = new Date();
        const timestamp = now.toLocaleString('ja-JP', { hour12: false });

        let msg, color, judgmentText, productText = product || '';

        if (product) {
            if (product === previousProduct) {
                // 重複
                msg = `NG: ${product} を重複して読み取りました<br>${barcode}`;
                color = 'red';
                judgmentText = 'NG(重複)';
            } else if (previousProduct !== null) {
                // 異なる商品
                msg = `OK: ${previousProduct} → ${product}<br>${barcode}`;
                color = '#28a745';
                judgmentText = 'OK(変更)';
            } else {
                // 最初のスキャン
                msg = `検出: ${product}<br>${barcode}`;
                color = '#007BFF';
                judgmentText = '検出';
            }
            previousProduct = product;
        } else {
            msg = `バーコードが認識できません<br>${barcode}`;
            color = 'gray';
            judgmentText = '不明';
        }

        showResult(msg, color);
        addHistoryEntry(timestamp, judgmentText, productText, barcode);
        stopScanner(); // 1件ごとに停止（必要ならここをコメントアウトで連続スキャン）
    }

    // onDetectedのラッパー（500msデバウンス）
    function onDetected(data) {
        const now = Date.now();
        if (now - onDetected.lastDetectedTime < 500) return;
        onDetected.lastDetectedTime = now;
        handleDetected(data);
    }
    onDetected.lastDetectedTime = 0;

    // ===== Quagga制御 =====
    function startScanner() {
        if (isScanning) return;

        clearResult();

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                singleChannel: false
            },
            decoder: {
                readers: ["code_128_reader"],
                multiple: false
            },
            locate: true,
            numOfWorkers: navigator.hardwareConcurrency || 4
        }, function(err) {
            if (err) {
                console.error(err);
                alert("バーコードスキャナーの初期化に失敗しました。");
                return;
            }
            Quagga.start();
            isScanning = true;
            document.getElementById('scanButton').textContent = "スキャン停止";
        });

        Quagga.onDetected(onDetected);
    }

    function stopScanner() {
        if (!isScanning) return;
        Quagga.stop();
        isScanning = false;
        document.getElementById('scanButton').textContent = "スキャン開始";
        Quagga.offDetected(onDetected);
    }

    // ===== イベント設定 =====
    document.getElementById('scanButton').addEventListener('click', function () {
        if (isScanning) {
            stopScanner();
        } else {
            startScanner();
        }
    });

    document.getElementById('resetButton').addEventListener('click', function () {
        clearResult();
        previousProduct = null;
        lastBarcode = null;
        sameCount = 0;
        stopScanner();
        startScanner();
    });

    // 名前選択
    const nameSelect = document.getElementById('nameSelect');
    const currentNameSpan = document.getElementById('currentName');

    nameSelect.addEventListener('change', function () {
        const name = nameSelect.value || '未選択';
        currentNameSpan.textContent = name;
    });

    // 印刷
    document.getElementById('printButton').addEventListener('click', function () {
        const selectedName = nameSelect.value;
        if (!selectedName) {
            alert('印刷する前に「名前」を選択してください。');
            return;
        }
        if (scanHistory.length === 0) {
            alert('スキャン履歴がありません。');
            return;
        }

        const nowStr = new Date().toLocaleString('ja-JP', { hour12: false });
        const printWindow = window.open('', '_blank');

        let html = `
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スキャン履歴</title>
<style>
body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    padding: 16px;
    font-size: 12px;
}
h1 {
    font-size: 20px;
    margin-bottom: 8px;
}
p {
    margin: 2px 0;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 11px;
}
th, td {
    border: 1px solid #000;
    padding: 3px 4px;
    text-align: center;
    white-space: nowrap;
}
thead {
    background: #f0f0f0;
}
</style>
</head>
<body>
<h1>バーコードスキャン履歴</h1>
<p>担当者：${selectedName}</p>
<p>印刷日時：${nowStr}</p>
<table>
<thead>
<tr>
  <th>No.</th>
  <th>時刻</th>
  <th>判定</th>
  <th>品番</th>
  <th>バーコード</th>
</tr>
</thead>
<tbody>
`;

        scanHistory.forEach((item, index) => {
            html += `
<tr>
  <td>${index + 1}</td>
  <td>${item.timestamp}</td>
  <td>${item.judgment}</td>
  <td>${item.product || ''}</td>
  <td>${item.barcode}</td>
</tr>
`;
        });

        html += `
</tbody>
</table>
</body>
</html>`;

        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    });

    // 初期状態
    clearResult();
</script>
</body>
</html>
