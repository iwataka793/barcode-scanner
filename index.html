<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.6em;
            margin: 18px 0 10px;
        }

        /* ===== カメラ表示領域 ===== */
        #interactive.viewport {
            position: relative;
            width: 95vw;
            height: 50vh;           /* 縦画面用：十分な高さ */
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translateZ(0);
            will-change: transform;
        }

        /* 横画面のときは幅いっぱい＆少し高め */
        @media (orientation: landscape) {
            #interactive.viewport {
                width: 100vw;
                height: 60vh;      /* シンプルに60vh使う */
            }
        }

        /* ガイド枠 */
        #interactive.viewport::before {
            content: "";
            position: absolute;
            top: 30%;
            left: 5%;
            width: 90%;
            height: 40%;
            border: 3px solid rgba(0, 255, 0, 0.7);
            pointer-events: none;
            box-sizing: border-box;
        }

        /* 結果表示エリア */
        #result {
            margin-top: 12px;
            padding: 14px;
            border-radius: 10px;
            font-size: 1.4em;
            color: #fff;
            display: none;
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        /* ===== ボタン類 ===== */
        #controls {
            margin-top: 14px;
            display: flex;
            gap: 14px;
        }

        .button {
            padding: 13px 28px;
            font-size: 1.25em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        #scanButton { background-color: #007BFF; }
        #resetButton { background-color: #dc3545; }
        #printButton { background-color: #007BFF; }

        /* ===== 名前選択＋表示 ===== */
        #nameArea {
            margin-top: 14px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #nameSelect {
            font-size: 1em;
            padding: 6px 12px;
            border-radius: 8px;
        }

        #operatorDisplay {
            margin-top: 4px;
            font-size: 1.2em;
        }

        /* ===== 履歴テーブル ===== */
        #historyContainer {
            width: 95%;
            background: white;
            margin-top: 18px;
            padding: 14px;
            border-radius: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #historyContainer h2 {
            margin: 0 0 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.05em;
            text-align: center;
        }

        th, td {
            border-bottom: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background: #eee;
        }

        /* ===== 印刷時 ===== */
        @media print {
            body {
                background: #fff;
            }
            #interactive,
            #controls,
            #nameSelect {
                display: none;
            }
            h1 {
                margin-top: 0;
            }
            #result {
                display: none !important;
            }
        }
    </style>

    <!-- QuaggaJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>

<h1>バーコードスキャナー</h1>

<div id="interactive" class="viewport"></div>

<div id="controls">
    <button id="scanButton" class="button">スキャン開始</button>
    <button id="resetButton" class="button">リセット</button>
    <button id="printButton" class="button">印刷</button>
</div>

<div id="nameArea">
    <span>名前：</span>
    <select id="nameSelect">
        <option value="">選択してください</option>
        <!-- ★ ここに事前に使う名前を増やしておけば楽 -->
        <option value="岩田薫">岩田薫</option>
        <option value="佐藤">佐藤</option>
        <option value="田中">田中</option>
        <option value="高橋">高橋</option>
    </select>
</div>

<div id="operatorDisplay">担当者：<span id="operatorName">未選択</span></div>

<div id="result"></div>

<div id="historyContainer">
    <h2>スキャン履歴（最大100件）</h2>
    <div id="historyMeta"></div>
    <table id="historyTable">
        <thead>
            <tr>
                <th>No.</th>
                <th>時刻</th>
                <th>判定</th>
                <th>品番</th>
                <th>バーコード</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
/* ==== 商品マッピング ==== */
const productPatterns = {
    "5863S": "X-92-122",
    "GFEYS": "PLR-2"
    // 必要に応じてここに追加
};

let previousProduct = null;
let isScanning = false;
let history = [];

/* 誤認識対策用 */
let lastDetectedCode = null;
let confirmCount = 0;
let lastDetectedTime = 0;

/* ===== 表示関連 ===== */
function showResult(message, color) {
    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';
    resultDiv.style.backgroundColor = color;
    resultDiv.innerHTML = message;
}

/* 履歴追加（最大100件） */
function addHistory(judge, product, barcode) {
    const now = new Date().toLocaleString();
    history.unshift({ time: now, judge, product, barcode });
    if (history.length > 100) {
        history.pop();
    }
    updateHistoryTable();
}

/* 履歴テーブル更新 */
function updateHistoryTable() {
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    history.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.time}</td>
            <td>${item.judge}</td>
            <td>${item.product}</td>
            <td>${item.barcode}</td>
        `;
        tbody.appendChild(tr);
    });

    // 印刷用のメタ情報（担当者＋件数）
    const name = document.getElementById('operatorName').textContent;
    const metaDiv = document.getElementById('historyMeta');
    metaDiv.textContent = `担当者：${name} / 件数：${history.length}`;
}

/* セグメント抽出＆分類 */
function extractImportantSegment(barcode) {
    if (barcode.length >= 9) {
        return barcode.substring(4, 9);  // 5文字
    }
    return null;
}

function classifyProduct(barcode) {
    const seg = extractImportantSegment(barcode);
    if (!seg) return null;
    return productPatterns[seg] || null;
}

/* 検出処理本体 */
function handleDetected(barcode) {
    const product = classifyProduct(barcode);

    if (product) {
        if (product === previousProduct) {
            showResult(`NG: ${product} を重複して読み取りました<br>${barcode}`, 'red');
            addHistory('NG(重複)', product, barcode);
        } else {
            if (previousProduct !== null) {
                showResult(`OK: ${previousProduct} → ${product}<br>${barcode}`, '#28a745');
                addHistory('OK(変更)', product, barcode);
            } else {
                showResult(`検出: ${product}<br>${barcode}`, '#007BFF');
                addHistory('OK', product, barcode);
            }
        }
        previousProduct = product;
    } else {
        showResult(`バーコードが認識できません<br>${barcode}`, 'gray');
        addHistory('不明', '-', barcode);
    }

    stopScanner();
}

/* Quagga の onDetected（誤認識対策入り） */
function onDetected(data) {
    const now = Date.now();
    if (now - lastDetectedTime < 400) {   // 400ms以内は無視
        return;
    }
    lastDetectedTime = now;

    const code = data.codeResult.code;

    // 同じコードを2回連続で読んだときだけ確定
    if (code === lastDetectedCode) {
        confirmCount += 1;
    } else {
        lastDetectedCode = code;
        confirmCount = 1;
    }

    if (confirmCount >= 2) {
        // 確定したのでリセット
        lastDetectedCode = null;
        confirmCount = 0;
        handleDetected(code);
    }
}

/* ===== スキャナ制御 ===== */
function startScanner() {
    if (isScanning) return;

    document.getElementById('result').style.display = 'none';

    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        },
        decoder: {
            readers: ["code_128_reader"]
        },
        locate: true
    }, function(err) {
        if (err) {
            console.error(err);
            alert("バーコードスキャナーの初期化に失敗しました。");
            return;
        }
        Quagga.start();
        isScanning = true;
        Quagga.onDetected(onDetected);
        document.getElementById('scanButton').textContent = "スキャン停止";
    });
}

function stopScanner() {
    if (!isScanning) return;
    Quagga.stop();
    Quagga.offDetected(onDetected);
    isScanning = false;
    document.getElementById('scanButton').textContent = "スキャン開始";
}

/* ===== イベント設定 ===== */
document.getElementById('scanButton').addEventListener('click', function() {
    if (isScanning) {
        stopScanner();
    } else {
        startScanner();
    }
});

document.getElementById('resetButton').addEventListener('click', function() {
    previousProduct = null;
    history = [];
    updateHistoryTable();
    document.getElementById('result').style.display = 'none';
});

document.getElementById('printButton').addEventListener('click', function() {
    const nameSelect = document.getElementById('nameSelect');
    if (!nameSelect.value) {
        alert('印刷前に名前を選択してください。');
        return;
    }
    window.print();
});

document.getElementById('nameSelect').addEventListener('change', function() {
    const name = this.value || '未選択';
    document.getElementById('operatorName').textContent = name;
    updateHistoryTable();
});

/* 初期表示 */
updateHistoryTable();
</script>

</body>
</html>
