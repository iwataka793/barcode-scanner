<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>バーコードスキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <style>
        /* ============================
           基本スタイル
        ============================ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: background-color 0.5s ease;
        }

        h1 {
            margin: 16px 0;
            font-size: 2rem;
        }

        /* ============================
           カメラビュー（縦画面）
        ============================ */
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 40vh;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translateZ(0);
            will-change: transform;
        }

        /* ============================
           ★ 横画面時：潰れ防止 ★
        ============================ */
        @media (orientation: landscape) {
            #interactive.viewport {
                width: 100vw;
                height: calc(100vw * 0.56); /* 16:9比率で安定 */
                max-height: 80vh;
            }
            #interactive.viewport video {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transform: translateZ(0);
                will-change: transform;
            }
        }

        /* スキャンガイド枠 */
        #interactive.viewport::before {
            content: "";
            position: absolute;
            top: 30%;
            left: 5%;
            width: 90%;
            height: 40%;
            border: 2px solid rgba(0, 255, 0, 0.7);
            box-sizing: border-box;
            pointer-events: none;
        }

        /* ============================
           結果表示
        ============================ */
        #result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            display: none;
            text-align: center;
            width: 94%;
            max-width: 700px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            word-break: break-word;
        }

        /* ============================
           ボタン類
        ============================ */
        #controls {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .button {
            padding: 12px 24px;
            font-size: 1.1em;
            border-radius: 10px;
            border: none;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .button:hover { background-color: #0056b3; }

        #resetButton { background-color: #dc3545; }
        #resetButton:hover { background-color: #c82333; }

        #printButton { background-color: #28a745; }
        #printButton:hover { background-color: #1f7a33; }

        /* ============================
           名前選択
        ============================ */
        #nameRow {
            margin-top: 10px;
            width: 94%;
            max-width: 700px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #userName {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: white;
        }

        /* ============================
           履歴テーブル
        ============================ */
        #historyContainer {
            margin-top: 10px;
            width: 94%;
            max-width: 700px;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        #historyTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        #historyTable th, #historyTable td {
            border: 1px solid #ccc;
            padding: 4px 6px;
            word-break: break-all;
        }

        #historyTable th {
            background: #f5f5f5;
        }

        /* ============================
           印刷用設定
        ============================ */
        #printHeader {
            display: none;
            width: 94%;
            max-width: 700px;
            margin-top: 10px;
        }

        @media print {
            #interactive, #controls, #result, #nameRow { display: none !important; }
            body, html { background: white; }
            #printHeader { display: block !important; }
            #historyContainer { box-shadow: none; }
        }
    </style>

    <!-- QuaggaJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body>

    <h1>バーコードスキャナー</h1>

    <div id="interactive" class="viewport"></div>
    <div id="result"></div>

    <div id="controls">
        <button id="scanButton" class="button">スキャン開始</button>
        <button id="resetButton" class="button">リセット</button>
        <button id="printButton" class="button">印刷</button>
    </div>

    <div id="nameRow">
        <span>名前：</span>
        <select id="userName">
            <option value="">選択してください</option>
            <option value="岩田 薫">岩田 薫</option>
            <option value="A班">A班</option>
            <option value="B班">B班</option>
        </select>
    </div>

    <!-- 印刷ヘッダー（プリント時だけ表示） -->
    <div id="printHeader">
        <div>作業者：<span id="printUserName"></span></div>
        <div>印刷日時：<span id="printDateTime"></span></div>
    </div>

    <!-- 履歴 -->
    <div id="historyContainer">
        <h2>スキャン履歴（最大100件）</h2>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>時刻</th>
                    <th>判定</th>
                    <th>品番</th>
                    <th>バーコード</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
/* ============================
   エラー
============================ */
window.onerror = function(msg){
    alert("エラー: " + msg);
};

/* ============================
   パターン
============================ */
const productPatterns = {
    "5863S": "X-92-122",
    "GFEYS": "PLR-2"
};

const MAX_HISTORY = 100;
let scanHistory = [];
let previousProduct = null;
let isScanning = false;

/* ============================
   ユーティリティ
============================ */
function nowStr(){
    const d = new Date();
    const p = n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

function classifyProduct(barcode){
    if(barcode.length < 9) return null;
    const seg = barcode.substring(4, 9);
    return productPatterns[seg] || null;
}

function showResult(msg, color){
    const r = document.getElementById("result");
    r.style.backgroundColor = color;
    r.innerHTML = msg;
    r.style.display = "block";
}

function clearResult(){
    document.getElementById("result").style.display = "none";
}

/* ============================
   履歴
============================ */
function addHistory(status, product, barcode){
    scanHistory.push({
        time: nowStr(),
        status,
        product,
        barcode
    });
    if(scanHistory.length > MAX_HISTORY) scanHistory.shift();
    renderHistory();
}

function renderHistory(){
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";
    scanHistory.forEach((h,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${h.time}</td>
            <td>${h.status}</td>
            <td>${h.product}</td>
            <td>${h.barcode}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ============================
   検出処理（誤認識防止版）
============================ */
function handleDetected(data){
    const code = data.codeResult.code;
    const product = classifyProduct(code);
    const t = nowStr();

    if(product){
        if(product === previousProduct){
            showResult(`NG（重複）<br>${product}<br>${code}<br>${t}`, "red");
            addHistory("NG（重複）", product, code);
        }else{
            if(previousProduct){
                showResult(`OK（切替）<br>${previousProduct} → ${product}<br>${code}<br>${t}`, "green");
                addHistory("OK（切替）", product, code);
            }else{
                showResult(`検出<br>${product}<br>${code}<br>${t}`, "blue");
                addHistory("検出", product, code);
            }
        }
        previousProduct = product;
        stopScanner();
    }else{
        showResult(`分類不可<br>${code}<br>${t}`, "gray");
        addHistory("分類不可", "", code);
    }
}

/* 誤検出防止：2回連続検出で確定 */
function onDetected(data){
    const code = data.codeResult.code;
    const now = Date.now();

    if(code !== onDetected.lastCode){
        onDetected.lastCode = code;
        onDetected.lastTime = now;
        onDetected.count = 1;
        return;
    }

    if(now - onDetected.lastTime < 1500){
        onDetected.count++;
        if(onDetected.count >= 2){
            handleDetected(data);
            onDetected.count = 0;
        }
    }
};
onDetected.lastCode = null;
onDetected.lastTime = 0;
onDetected.count = 0;

/* ============================
   Quagga
============================ */
function startScanner(){
    if(isScanning) return;
    clearResult();

    Quagga.init({
        inputStream:{
            name:"Live",
            type:"LiveStream",
            target:document.querySelector("#interactive"),
            constraints:{
                facingMode:"environment",
                width:{ideal:1280},
                height:{ideal:720}
            }
        },
        decoder:{
            readers:["code_128_reader"]
        },
        locate:true
    },err=>{
        if(err){ alert("起動エラー"); return; }
        Quagga.start();
        isScanning = true;
        document.getElementById("scanButton").textContent = "スキャン停止";
        Quagga.onDetected(onDetected);
    });
}

function stopScanner(){
    if(!isScanning) return;
    Quagga.stop();
    isScanning = false;
    document.getElementById("scanButton").textContent = "スキャン開始";
    Quagga.offDetected(onDetected);
}

/* ============================
   印刷
============================ */
function printHistory(){
    const name = document.getElementById("userName").value || "（未選択）";
    document.getElementById("printUserName").textContent = name;
    document.getElementById("printDateTime").textContent = nowStr();
    window.print();
}

/* ============================
   イベント
============================ */
document.getElementById("scanButton").onclick = ()=>{
    isScanning ? stopScanner() : startScanner();
};

document.getElementById("resetButton").onclick = ()=>{
    stopScanner();
    scanHistory = [];
    previousProduct = null;
    renderHistory();
    clearResult();
};

document.getElementById("printButton").onclick = printHistory;

renderHistory();
clearResult();
</script>

</body>
</html>
